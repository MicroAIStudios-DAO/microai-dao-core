# MicroAI DAO - Docker Compose
# Unified deployment for all services

version: '3.8'

services:
  # ===================
  # Core API Service
  # ===================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - FLASK_ENV=${FLASK_ENV:-production}
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-https://api.devnet.solana.com}
    volumes:
      - ../src:/app/src:ro
      - ../api:/app/api:ro
    networks:
      - microai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================
  # Live Data Server (Solana)
  # ===================
  live-data:
    image: node:18-slim
    working_dir: /app
    ports:
      - "8787:8787"
    environment:
      - PORT=8787
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-https://api.devnet.solana.com}
      - GOVERNANCE_PROGRAM_ID=${GOVERNANCE_PROGRAM_ID:-6amHFyNoPK9MmbBKqthLMeoxTB4TV7CdVE5K4RXi1eDC}
    volumes:
      - ../services/live-data-server:/app:ro
    command: node live-data-server.js
    networks:
      - microai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================
  # Dashboard (Development)
  # ===================
  dashboard:
    image: node:18-slim
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ../microai-dashboard:/app
    command: sh -c "npm install && npm run dev -- --host"
    networks:
      - microai-network
    depends_on:
      - api
      - live-data
    profiles:
      - dev

  # ===================
  # EXECAI Voter Agent
  # ===================
  execai:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    environment:
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-https://api.devnet.solana.com}
      - EXECAI_KEYPAIR_PATH=/keys/execai.json
      - API_URL=http://api:5000
    volumes:
      - ../src:/app/src:ro
      - ${SOLANA_KEYS_PATH:-~/.config/solana}:/keys:ro
    command: python -m personas.execai_client
    networks:
      - microai-network
    depends_on:
      - api
      - live-data
    profiles:
      - agent

networks:
  microai-network:
    driver: bridge

volumes:
  node_modules:
